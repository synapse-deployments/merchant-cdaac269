name: Deploy to Shopify and Fly.io

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Check for Rust functions
        id: check_rust
        run: |
          if find extensions -name "Cargo.toml" -type f | grep -q .; then
            echo "has_rust=true" >> $GITHUB_OUTPUT
            echo "ğŸ¦€ Rust functions detected"
          else
            echo "has_rust=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No Rust functions found"
          fi

      - name: Setup Rust toolchain
        if: steps.check_rust.outputs.has_rust == 'true'
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown

      - name: Install wasm-opt
        if: steps.check_rust.outputs.has_rust == 'true'
        run: |
          npm install -g wasm-opt
          echo "âœ… WASM tools installed"

      - name: Setup Shopify CLI
        run: npm install -g @shopify/cli @shopify/app

      - name: Deploy to Shopify
        env:
          SHOPIFY_CLI_PARTNERS_TOKEN: ${{ secrets.SHOPIFY_CLI_PARTNERS_TOKEN }}
          SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY }}
          SHOPIFY_API_SECRET: ${{ secrets.SHOPIFY_API_SECRET }}
        run: |
          echo "ğŸ“¦ Deploying extensions and functions to Shopify..."
          shopify app deploy --client-id ${{ secrets.SHOPIFY_API_KEY }} --force
          echo "âœ… Deployed to Shopify"

      - name: Check for Dockerfile
        id: check_dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "has_dockerfile=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Dockerfile found - will deploy to Fly.io"
          else
            echo "has_dockerfile=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No Dockerfile - skipping Fly.io deployment"
          fi

      - name: Setup Fly.io CLI
        if: steps.check_dockerfile.outputs.has_dockerfile == 'true'
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        if: steps.check_dockerfile.outputs.has_dockerfile == 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "ğŸš€ Deploying app to Fly.io..."
          flyctl deploy --remote-only
          echo "âœ… App deployed to Fly.io"

      - name: Deployment summary
        run: |
          echo "âœ… Deployment complete"
          echo "ğŸ“¦ Extensions: Deployed to Shopify"
          if [ -f "Dockerfile" ]; then
            echo "ğŸš€ App: Deployed to Fly.io"
          else
            echo "â„¹ï¸  App: No backend to deploy (extensions only)"
          fi
